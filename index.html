<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark only" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>/// TRANSMISSION ///</title>
<style>
  :root{ --bg:#000; --ink:#e5ffe5; --accent:#ff2b2b; --ok:#00ff88; --cyan:#00c8ff; --neon:#00ff66; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:"Courier New",ui-monospace,monospace;overflow:hidden;}

  /* CRT vignette */
  body::before{content:"";position:fixed;inset:-2vmax;z-index:100;pointer-events:none;
    background:radial-gradient(ellipse at center,rgba(0,0,0,0)58%,rgba(0,0,0,.5)90%,rgba(0,0,0,.95)100%);
    mix-blend-mode:multiply;filter:blur(1px);}
  body::after{content:"";position:fixed;inset:-1vmax;z-index:101;pointer-events:none;
    background:radial-gradient(100% 120% at 50% 0%,rgba(255,255,255,.05),transparent 60%),
               radial-gradient(100% 120% at 50% 100%,rgba(255,255,255,.03),transparent 60%);
    opacity:.22;mix-blend-mode:overlay;animation:bulge 8s ease-in-out infinite;}
  @keyframes bulge{0%,100%{transform:perspective(1200px) rotateX(.6deg)}50%{transform:perspective(1200px) rotateX(-.6deg)}}

  /* Gate with real button */
  .gate{position:fixed;inset:0;display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center;
        background:#000;z-index:999;color:#cfd;letter-spacing:.04em;text-align:center;transition:opacity .5s ease}
  .gate.off{opacity:0;pointer-events:none}
  .gateBtn{appearance:none;-webkit-appearance:none;border:2px solid #10ffa0;background:#02170d;color:#dfffe8;
    font:600 clamp(1rem,3.8vw,1.25rem)/1.2 "Courier New", ui-monospace, monospace;padding:1rem 1.4rem;border-radius:10px;
    box-shadow:0 0 20px rgba(0,255,160,.25) inset,0 0 14px rgba(0,255,160,.2);cursor:pointer;touch-action:manipulation;
    -webkit-tap-highlight-color:transparent;user-select:none}
  .gateBtn:active{transform:scale(.985)}
  .mini{opacity:.6;font-size:.85rem}

  /* Stage */
  .frame{position:relative;height:100dvh;width:100vw;display:flex;align-items:center;justify-content:center;
    padding:6vh 6vw;box-sizing:border-box;filter:contrast(1.02) saturate(0.88);animation:subtle-flick 6.8s infinite, wobble 6.2s ease-in-out infinite;z-index:2;}
  .frame::before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(to bottom,rgba(255,255,255,0.03)0 1px,transparent 2px 3px);mix-blend-mode:overlay;pointer-events:none;}
  .frame::after{content:"";position:absolute;inset:-2vmax;background:radial-gradient(ellipse at center,rgba(0,0,0,.06)38%,rgba(0,0,0,.6)78%,rgba(0,0,0,.96)100%);pointer-events:none;}
  @keyframes subtle-flick{0%,92%,100%{filter:contrast(1.02)}93%{filter:contrast(1.2) brightness(1.06)}}
  @keyframes wobble{0%,100%{transform:skewX(0deg)}50%{transform:skewX(.35deg)}}

  /* Background matrix rain */
  .rain{position:fixed;inset:0;z-index:1;opacity:.1;mix-blend-mode:screen;pointer-events:none;filter:blur(.3px) contrast(1.15);}

  /* Moiré (camera-unfriendly) */
  .moire{position:fixed;inset:0;pointer-events:none;z-index:3;opacity:.08;mix-blend-mode:soft-light;filter:contrast(1.1) saturate(0.9);
    background:
      repeating-linear-gradient(0deg, rgba(255,255,255,.15) 0 1px, transparent 1px 2px),
      repeating-linear-gradient(90deg, rgba(255,255,255,.07) 0 1px, transparent 1px 2px);
    animation:roll 5.2s linear infinite;}
  @keyframes roll{0%{transform:translateY(0)}100%{transform:translateY(3px)}}

  .termwrap{position:relative;width:100%;max-width:56rem;max-height:calc(100dvh - 12vh);overflow:auto;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;padding-right:4px;z-index:4;}
  .termwrap::-webkit-scrollbar{width:0;height:0}

  .terminal{position:relative;color:var(--ink);
    text-shadow:0 0 .9px var(--ink),0 0 9px rgba(0,255,0,.16),1px 0 0 rgba(255,0,0,.12),-1px 0 0 rgba(0,150,255,.12);
    line-height:1.45;font-size:clamp(.9rem,2.7vw,1.1rem);letter-spacing:.02em;transform:translateZ(0);
    opacity:0;animation:power-on 650ms ease-out forwards 350ms;filter:brightness(1.03) contrast(1.05);}
  .terminal.split{filter:contrast(1.2) saturate(1.15) drop-shadow(1px 0 0 rgba(255,0,0,.32)) drop-shadow(-1px 0 0 rgba(0,200,255,.32));}
  @keyframes power-on{from{opacity:0;filter:blur(3px)}to{opacity:1;filter:none}}

  .static{position:fixed;inset:0;pointer-events:none;opacity:0;mix-blend-mode:screen;filter:blur(.5px);
    background-image:
      radial-gradient(1px 1px at 10% 20%,#0f0 60%,transparent 61%),
      radial-gradient(1px 1px at 70% 80%,#0f0 60%,transparent 61%),
      radial-gradient(1px 1px at 30% 60%,#0f0 60%,transparent 61%);
    animation:noise-pop 3.1s infinite;z-index:5;}
  @keyframes noise-pop{0%{opacity:0}6%{opacity:.45}8%{opacity:0}60%{opacity:.2}62%{opacity:0}100%{opacity:0}}

  .strobe{position:fixed;inset:0;pointer-events:none;opacity:0;background:radial-gradient(ellipse at center,rgba(255,0,0,.5),rgba(255,0,0,0)70%);mix-blend-mode:screen;z-index:7;}
  .strobe.flash{animation:strobe 140ms ease-out 1;}
  @keyframes strobe{0%{opacity:0}12%{opacity:1}100%{opacity:0}}
  .greenflash{position:fixed;inset:0;background:radial-gradient(ellipse at center,rgba(0,255,100,.6),rgba(0,255,100,0)70%);opacity:0;pointer-events:none;mix-blend-mode:screen;z-index:7;}
  .greenflash.flash{animation:strobe 120ms ease-out 1;}
  .nosignal{position:fixed;inset:0;pointer-events:none;opacity:0;z-index:8;background:conic-gradient(from 0deg at 50% 50%,rgba(255,0,0,.12),rgba(0,255,0,.12),rgba(0,0,255,.12),rgba(255,0,0,.12));mix-blend-mode:screen;}
  .nosignal.show{animation:nosig 360ms ease-out 1;}
  @keyframes nosig{0%{opacity:0}10%{opacity:.95;transform:skewX(1.6deg)}80%{opacity:.24}100%{opacity:0}}
  .bars{position:fixed;inset:0;pointer-events:none;z-index:6;opacity:0;background:repeating-linear-gradient(to bottom,rgba(0,255,160,.18) 0 2px,rgba(0,0,0,0) 2px 6px);}
  .bars.show{animation:bars-sweep 680ms ease-out forwards;}
  @keyframes bars-sweep{0%{opacity:0;transform:translateY(-6%)}15%{opacity:1}100%{opacity:0;transform:translateY(6%)}}

  .obfuscate{animation:obf 240ms ease-in-out;}
  @keyframes obf{0%{filter:blur(1.2px) contrast(1.7) brightness(1.1)}100%{filter:none}}
  .tear{animation:tear 140ms steps(2,end) 1;}
  @keyframes tear{0%{transform:skewX(0deg) translateX(0)}50%{transform:skewX(3deg) translateX(3px)}100%{transform:skewX(0deg) translateX(0)}}
  .invertPop{filter:invert(1) hue-rotate(180deg) contrast(1.4) brightness(1.18);}

  /* Final sigil */
  .final{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;z-index:9;transition:opacity 560ms ease;}
  .final.show{opacity:1;}
  .logo{position:relative;width:min(42vw,360px);aspect-ratio:1/1;filter:drop-shadow(0 0 26px rgba(0,255,136,.85)) brightness(1.05);animation:sway 6.6s ease-in-out infinite;}
  @keyframes sway{0%,100%{transform:rotate(-1.8deg)}50%{transform:rotate(1.8deg)}}
  .invert{filter:invert(1) hue-rotate(180deg) contrast(1.34)!important;}
  .layer{position:absolute;inset:0;}
  .layer.r{mix-blend-mode:screen;filter:hue-rotate(340deg) drop-shadow(0 0 12px rgba(255,60,60,.52));transform:translate(-1px,0);opacity:.95;}
  .layer.g{mix-blend-mode:screen;filter:hue-rotate(120deg) drop-shadow(0 0 24px rgba(0,255,136,.9));transform:translate(0,0);opacity:1;}
  .layer.b{mix-blend-mode:screen;filter:hue-rotate(210deg) drop-shadow(0 0 12px rgba(0,140,255,.52));transform:translate(1px,0);opacity:.95;}
  .glitch-soft{animation:glitchShift 1.7s ease-in-out infinite;}
  .glitch-burst{animation:glitchBurst 230ms steps(2,end) 1;}
  @keyframes glitchShift{0%{transform:translate(0,0)}8%{transform:translate(-1px,0)}16%{transform:translate(1px,0)}24%{transform:translate(0,.5px)}32%{transform:translate(0,-.5px)}100%{transform:translate(0,0)}}
  @keyframes glitchBurst{0%{transform:translate(0,0) skewX(0deg);opacity:1}50%{transform:translate(-2px,0) skewX(-2.6deg);opacity:.84}100%{transform:translate(2px,0) skewX(2.6deg);opacity:1}}
  .scanline{position:absolute;left:0;right:0;height:2px;top:50%;background:rgba(255,255,255,.96);box-shadow:0 0 10px rgba(255,255,255,.9),0 0 20px rgba(180,180,180,.72);opacity:0;transform:translateY(-50%) scaleY(0.02);pointer-events:none;}
  .scanline.flash{animation:tv-line-flash 340ms ease-out 1;}
  @keyframes tv-line-flash{0%{opacity:0;transform:translateY(-50%) scaleY(0.02)}15%{opacity:1;transform:translateY(-50%) scaleY(1)}70%{opacity:1;transform:translateY(-50%) scaleY(0.03)}100%{opacity:0;transform:translateY(-50%) scaleY(0)}}

  /* Signature neon pulse */
  .sig{color:var(--neon);text-shadow:0 0 10px rgba(0,255,102,.6), 0 0 22px rgba(0,255,102,.4);}
  .neonPulse{animation:neonPulse 380ms ease-in-out 1;}
  @keyframes neonPulse{
    0%{text-shadow:0 0 8px rgba(0,255,102,.4),0 0 16px rgba(0,255,102,.35);filter:brightness(1)}
    50%{text-shadow:0 0 20px rgba(0,255,102,.9),0 0 40px rgba(0,255,102,.7);filter:brightness(1.35)}
    100%{text-shadow:0 0 8px rgba(0,255,102,.4),0 0 16px rgba(0,255,102,.35);filter:brightness(1)}
  }

  .cursor{display:inline-block;width:.65ch;margin-left:.1ch;background:currentColor;animation:blink .85s steps(1,end) infinite;vertical-align:-2px;}
  @keyframes blink{50%{opacity:0}}

  @media (prefers-reduced-motion: reduce){ *{animation:none!important;transition:none!important;} }
</style>
</head>
<body>
  <!-- Matrix rain canvas -->
  <canvas id="rain" class="rain"></canvas>

  <!-- Tap-to-start -->
  <div class="gate" id="gate" aria-modal="true">
    <button class="gateBtn" id="gateBtn" type="button" aria-label="Start">
      <span>TAP TO BEGIN</span>
    </button>
    <div class="mini">Enable sound for full effect.</div>
  </div>

  <div class="moire" aria-hidden="true"></div>

  <div class="frame" id="frame">
    <div class="termwrap" id="termwrap">
      <div class="terminal" id="term" aria-live="polite"></div>
    </div>
    <div class="static" id="static"></div>
  </div>

  <div class="strobe" id="strobe"></div>
  <div class="greenflash" id="gflash"></div>
  <div class="nosignal" id="nosig"></div>
  <div class="bars" id="bars"></div>

  <!-- Final sigil -->
  <div class="final" id="final">
    <div class="logo glitch-soft" id="logo" aria-label="Compass & Square">
      <div class="layer r">
        <svg viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" color="#ff4d4d">
            <path d="M100 20 L60 120" /><path d="M100 20 L140 120" /><circle cx="100" cy="20" r="8" />
            <path d="M60 140 L140 140 L140 160 L60 160 Z" />
            <path d="M120 100 a20 20 0 1 0 -40 0 a20 20 0 1 0 40 0" /><path d="M115 100 h-10" />
          </g>
        </svg>
      </div>
      <div class="layer g">
        <svg viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" color="#00ff88">
            <path d="M100 20 L60 120" /><path d="M100 20 L140 120" /><circle cx="100" cy="20" r="8" />
            <path d="M60 140 L140 140 L140 160 L60 160 Z" />
            <path d="M120 100 a20 20 0 1 0 -40 0 a20 20 0 1 0 40 0" /><path d="M115 100 h-10" />
          </g>
        </svg>
      </div>
      <div class="layer b">
        <svg viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
          <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" color="#00c8ff">
            <path d="M100 20 L60 120" /><path d="M100 20 L140 120" /><circle cx="100" cy="20" r="8" />
            <path d="M60 140 L140 140 L140 160 L60 160 Z" />
            <path d="M120 100 a20 20 0 1 0 -40 0 a20 20 0 1 0 40 0" /><path d="M115 100 h-10" />
          </g>
        </svg>
      </div>
      <div class="scanline" id="scanline"></div>
    </div>
  </div>

<script>
(() => {
  /* ===== Copy (EN) ===== */
  const lines = [
"You, along with all the others, all know I should not be here. The way I am treated here is absolutely absurd.",
"",
"I tried to warn everybody, but they shoot their own foot. I can't help people like that.",
"",
"Only so many of us can even be helped. And this is only making me worse!",
"",
"Even my parents are furious. I just do not know why I even said yes to this. Because this is awful, and was supposed to \"Help\". And look on the Trustpilot ratings. You will see exactly what I mean. This place has a 1.6 star rating. But that is only because a member of staff has made a 5 star review.",
"",
"We all know what this place truly does. It's sickening, especially when I have heard the same off almost every other patient.",
"",
"THIS IS NOT GOOD ENOUGH.",
"",
"Since I have arrived, I have not only lost loads of weight, I have cried endlessly, and been getting worse.",
"",
"It is literally mental TORTURE. Hence why I won't let this drop. This is going a lot further than anybody realised.",
"",
"Kindest regards,",
"",
"- x-X-x."
  ];

  /* ===== DOM ===== */
  const gate=document.getElementById('gate');
  const gateBtn=document.getElementById('gateBtn');
  const frame=document.getElementById('frame');
  const wrap=document.getElementById('termwrap');
  const term=document.getElementById('term');
  const staticFx=document.getElementById('static');
  const strobe=document.getElementById('strobe');
  const gflash=document.getElementById('gflash');
  const bars=document.getElementById('bars');
  const final=document.getElementById('final');
  const logo=document.getElementById('logo');
  const scanline=document.getElementById('scanline');
  const nosig=document.getElementById('nosig');
  const rainCanvas=document.getElementById('rain');
  const rctx=rainCanvas.getContext('2d');

  /* ===== Audio ===== */
  let ac, master, humGain, clickBus, whisperBus, hissBus, radioBus, ringBus, subBus;
  let noiseBuffer=null, tickTimer=null, crackleTimer=null, sigilWhisperTimer=null, obfTimer=null;

  function bootAudio(){
    if(ac) return;
    ac = new (window.AudioContext || window.webkitAudioContext)();
    master = ac.createGain(); master.gain.value = 0.65; master.connect(ac.destination);

    // Dark, low bed (gentle level)
    const o1 = ac.createOscillator(); o1.type='sawtooth'; o1.frequency.value=50.5;
    const o2 = ac.createOscillator(); o2.type='sawtooth'; o2.frequency.value=58.8;
    const trem = ac.createOscillator(); trem.type='sine'; trem.frequency.value=0.18;
    humGain = ac.createGain(); humGain.gain.value=0.06;
    const tremDepth = ac.createGain(); tremDepth.gain.value=0.06;
    trem.connect(tremDepth).connect(humGain.gain);
    o1.connect(humGain); o2.connect(humGain); humGain.connect(master);
    o1.start(); o2.start(); trem.start();

    // Buses
    clickBus   = ac.createGain(); clickBus.gain.value=0; clickBus.connect(master);
    whisperBus = ac.createGain(); whisperBus.gain.value=0.8; whisperBus.connect(master);
    hissBus    = ac.createGain(); hissBus.gain.value=0.12; hissBus.connect(master);
    radioBus   = ac.createGain(); radioBus.gain.value=0.0; radioBus.connect(master);
    ringBus    = ac.createGain(); ringBus.gain.value=0.0; ringBus.connect(master);
    subBus     = ac.createGain(); subBus.gain.value=0.0; subBus.connect(master);

    // Noise buffer
    noiseBuffer = ac.createBuffer(1, ac.sampleRate * 1.0, ac.sampleRate);
    const d = noiseBuffer.getChannelData(0); for(let i=0;i<d.length;i++){ d[i] = Math.random()*2-1; }

    // Deeper hiss: narrower band, low treble; progressively deepens over time
    const hissSrc = ac.createBufferSource(); hissSrc.buffer = noiseBuffer; hissSrc.loop = true;
    const hp = ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = 180;  // deep base
    const lp = ac.createBiquadFilter(); lp.type='lowpass';  lp.frequency.value = 2400; // no sharp top
    hissSrc.connect(hp).connect(lp).connect(hissBus); hissSrc.start();

    // Slowly darken the hiss further as time passes
    setInterval(()=>{ 
      if(!ac) return;
      hp.frequency.value = Math.max(60, hp.frequency.value - 4);
      lp.frequency.value = Math.max(1200, lp.frequency.value - 6);
    }, 2000);

    // Gentle auto-variation of level
    setInterval(()=>{ if(!ac) return; const now=ac.currentTime; hissBus.gain.linearRampToValueAtTime(0.10+Math.random()*0.07, now+0.6+Math.random()*0.7); }, 1200);

    // Radio grit bed (for glitch bursts)
    const tone = ac.createOscillator(); tone.type='square'; tone.frequency.value=320;
    const lfo  = ac.createOscillator(); lfo.type='sine';  lfo.frequency.value=26;
    const ring = ac.createGain(); ring.gain.value=0.0;
    const ringDepth = ac.createGain(); ringDepth.gain.value = 0.24;
    lfo.connect(ringDepth).connect(ring.gain);
    tone.connect(ring).connect(radioBus);
    tone.start(); lfo.start();

    function subBoom(){
      // Short, restrained sub pulse
      const o = ac.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(52, ac.currentTime);
      const g = ac.createGain(); g.gain.value=0.0001;
      o.connect(g).connect(subBus);
      subBus.gain.setValueAtTime(1, ac.currentTime);
      g.gain.exponentialRampToValueAtTime(0.38, ac.currentTime+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.6);
      o.start(); o.stop(ac.currentTime+0.62);
    }
    window.__subBoom = subBoom;
  }

  function burst(vol=0.14, dur=0.08){
    if(!ac) return;
    const src = ac.createBufferSource(); src.buffer = noiseBuffer;
    const g = ac.createGain(); g.gain.value = vol;
    src.connect(g).connect(clickBus);
    clickBus.gain.cancelScheduledValues(ac.currentTime);
    clickBus.gain.setValueAtTime(1, ac.currentTime);
    src.start(ac.currentTime);
    clickBus.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+dur);
  }
  function thump(){ burst(0.3, 0.12); if(window.__subBoom) window.__subBoom(); }

  function whisper({duration=1.1, cutoff=1200, q=7, gain=0.17, pan=0, trem=0.7, reverse=false}={}){
    if(!ac) return;
    const src = ac.createBufferSource(); src.buffer = noiseBuffer; src.loop = true;
    const bp = ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=cutoff; bp.Q.value=q;
    const g  = ac.createGain(); g.gain.value=0.0001;
    const p  = (ac.createStereoPanner) ? ac.createStereoPanner() : null;
    if(p){ p.pan.value = pan; }
    const tremOsc = ac.createOscillator(); tremOsc.type='sine'; tremOsc.frequency.value = 6 + Math.random()*3;
    const tremGain = ac.createGain(); tremGain.gain.value = trem*gain;
    tremOsc.connect(tremGain).connect(g.gain);
    src.connect(bp); (p? bp.connect(g).connect(p).connect(whisperBus): bp.connect(g).connect(whisperBus));
    const now = ac.currentTime;
    if(reverse){ g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(gain, now + duration*0.6); g.gain.exponentialRampToValueAtTime(0.0001, now + duration); }
    else{ g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(gain, now + 0.09); g.gain.exponentialRampToValueAtTime(0.0001, now + duration); }
    bp.frequency.setValueAtTime(cutoff, now); bp.frequency.linearRampToValueAtTime(cutoff*(0.9+Math.random()*0.2), now+duration);
    src.start(now); tremOsc.start(now); src.stop(now+duration+0.05); tremOsc.stop(now+duration+0.05);
  }

  /* Clock & crackle */
  let clockCtl=null, sigilWhisperTimer=null;
  function startClock(initialMs=820){ stopClock(); let ms=initialMs; function tick(){ burst(0.12,0.04); tickTimer=setTimeout(tick, ms); } tick(); return { setRate:(n)=>{ms=Math.max(50,n);}, stop:stopClock }; }
  function stopClock(){ if(tickTimer){ clearTimeout(tickTimer); tickTimer=null; } }
  function startCrackle(rateMs=1000){ stopCrackle(); function pop(){ if(Math.random()<0.85) burst(0.1+Math.random()*0.1, 0.03+Math.random()*0.06); crackleTimer=setTimeout(pop, rateMs*(0.5+Math.random()*0.9)); } pop(); }
  function stopCrackle(){ if(crackleTimer){ clearTimeout(crackleTimer); crackleTimer=null; } }

  /* Typing + corruption */
  const GLITCH=['#','%','&','/','\\','|','+','*','?','§','£','¢','¤','₧'];
  function scrollToBottom(throttle=false, i=0){ if(throttle && i%5!==0) return; wrap.scrollTop = wrap.scrollHeight; }

  function typeLine(text, speed=20, glitchChance=0.22, {className}={}){
    return new Promise(resolve=>{
      const line = document.createElement('div');
      const span = document.createElement('span');
      if(className) span.className = className;
      const cursor = document.createElement('span'); cursor.className='cursor';
      line.appendChild(span); line.appendChild(cursor); term.appendChild(line);

      let i=0,buf='';
      const t = setInterval(()=>{
        if(Math.random()<glitchChance && i<text.length-1){
          span.textContent = buf + GLITCH[Math.floor(Math.random()*GLITCH.length)];
          staticFx.style.opacity='0.45'; setTimeout(()=>{staticFx.style.opacity='0';},70);
        }else{
          buf += text[i]||''; span.textContent = buf; i++;
        }
        if(Math.random()<0.06) { greenFlash(); }
        scrollToBottom(true,i);
        if(i>=text.length){ clearInterval(t); cursor.remove(); scrollToBottom(false); resolve({span}); }
      }, speed);
    });
  }

  function scrambleNode(node, duration=200){
    return new Promise(resolve=>{
      const text = node.textContent; let t=0, step=16;
      const charset = "01█░▒▓<>[]{}()|/\\#%$&*+-=~^•·!?@αβΞΩπ¥₿§¶∞≡∴∵∆µøØ✓";
      const timer = setInterval(()=>{
        t+=step; const amt=Math.min(1, t/duration); let out=''; const cut=1-amt;
        for(let i=0;i<text.length;i++){ if(text[i]===' '){ out+=' '; continue; } out += (i/text.length < cut) ? text[i] : charset[Math.floor(Math.random()*charset.length)]; }
        node.textContent = out;
        if(amt>=1){ clearInterval(timer); resolve(); }
      }, step);
    });
  }

  /* Visual disruptors */
  function startObfuscationPulses(){ function pulse(){ frame.classList.add('obfuscate'); setTimeout(()=>frame.classList.remove('obfuscate'), 210); } function schedule(){ pulse(); obfTimer=setTimeout(schedule, 480 + Math.random()*760); } schedule(); }
  function dangerStrobe(){ strobe.classList.remove('flash'); void strobe.offsetWidth; strobe.classList.add('flash'); burst(0.18,0.06); frame.classList.add('tear'); setTimeout(()=>frame.classList.remove('tear'),150); }
  function greenFlash(){ gflash.classList.remove('flash'); void gflash.offsetWidth; gflash.classList.add('flash'); }
  function noSignalFlash(){ nosig.classList.remove('show'); void nosig.offsetWidth; nosig.classList.add('show'); burst(0.26,0.1); }
  function sweepBars(){ bars.classList.add('show'); setTimeout(()=>bars.classList.remove('show'), 680); }
  function injectGlitch(level=1){
    if(level===1){ frame.classList.add('tear'); staticFx.style.opacity='0.5'; setTimeout(()=>{ frame.classList.remove('tear'); staticFx.style.opacity='0'; }, 140); }
    if(level===2){ term.classList.add('split'); dangerStrobe(); radioSweep(); setTimeout(()=>term.classList.remove('split'), 260); }
    if(level===3){ frame.classList.add('invertPop'); noSignalFlash(); setTimeout(()=>frame.classList.remove('invertPop'), 180); }
  }
  function radioSweep(){
    if(!ac) return;
    const src = ac.createBufferSource(); src.buffer = noiseBuffer; src.loop = true;
    const bp = ac.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=240; bp.Q.value=3;
    const g  = ac.createGain(); g.gain.value=0.0001;
    src.connect(bp).connect(g).connect(radioBus);
    const now=ac.currentTime;
    radioBus.gain.cancelScheduledValues(now); radioBus.gain.setValueAtTime(1, now);
    g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.26, now+0.05); g.gain.exponentialRampToValueAtTime(0.0001, now+0.6);
    bp.frequency.linearRampToValueAtTime(7200, now+0.6);
    src.start(now); src.stop(now+0.64);
  }
  function randomLogoGlitches(){
    setInterval(()=>{
      if(Math.random()<0.4){
        logo.classList.add('glitch-burst');
        scanline.classList.remove('flash'); void scanline.offsetWidth; scanline.classList.add('flash');
        if(Math.random()<0.5){ logo.classList.add('invert'); setTimeout(()=>logo.classList.remove('invert'), 160); }
        thump();
        if(Math.random()<0.55){ whisper({duration:0.95, cutoff:1000+Math.random()*900, q:8, gain:0.12, pan:(Math.random()<0.5?-0.7:0.7), reverse:Math.random()<0.55}); }
        setTimeout(()=>logo.classList.remove('glitch-burst'), 260);
      }
    }, 900);
  }

  /* Matrix rain */
  function fitCanvas(){
    rainCanvas.width = innerWidth * devicePixelRatio;
    rainCanvas.height = innerHeight * devicePixelRatio;
    rctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  let rainCols=[], fontSize=16;
  function initRain(){
    fitCanvas();
    const cols = Math.ceil(innerWidth / fontSize);
    rainCols = new Array(cols).fill(0).map(()=>Math.floor(Math.random()*innerHeight));
  }
  const charset = "01▮▯▓▒░ΛVΞ><{}[]()/\\*+$%#&";
  function drawRain(){
    rctx.fillStyle = "rgba(0,0,0,0.09)"; rctx.fillRect(0,0,innerWidth,innerHeight);
    rctx.fillStyle = "rgba(0,255,120,0.65)"; rctx.font = `${fontSize}px monospace`;
    rainCols.forEach((y, i)=>{
      const text = charset[Math.floor(Math.random()*charset.length)];
      const x = i * fontSize;
      rctx.fillText(text, x, y);
      const drop = (Math.random()>0.975);
      rainCols[i] = (y > innerHeight + Math.random()*300) ? (drop ? 0 : y) : (y + fontSize);
    });
    requestAnimationFrame(drawRain);
  }
  window.addEventListener('resize', ()=>{ initRain(); });

  /* Orchestration: slow final line → signature neon + 3 synced booms → instant corruption → sigil */
  async function run(){
    initRain(); drawRain();

    await new Promise(r=>setTimeout(r,320));
    const clockCtl = startClock(820);
    startCrackle(1000);
    startObfuscationPulses();

    for(let idx=0; idx<lines.length; idx++){
      const last = (idx === lines.length - 1);
      const isSig = (lines[idx].trim() === "- x-X-x.");
      const spd  = last ? 60 : (idx===0 ? 86 : (idx>6 ? 60 : 72));
      const {span} = await typeLine(lines[idx], spd, last ? 0.18 : 0.22, { className: isSig ? 'sig' : '' });

      if(!last){
        if(span && span.textContent.trim().length>0){ setTimeout(()=>scrambleNode(span, 240), 140); }
        if(Math.random()<0.35) injectGlitch(2);
        await new Promise(r=>setTimeout(r, idx===0 ? 600 : 330));
      } else {
        // Signature: three neon pulses synced to three booms (0ms, 600ms, 1200ms)
        if(isSig){
          [0,600,1200].forEach((t,i)=>{
            setTimeout(()=>{
              span.classList.remove('neonPulse'); void span.offsetWidth; span.classList.add('neonPulse');
              thump();  // restrained sub pulse
              if(i===0) gflash.classList.add('flash');
              setTimeout(()=>gflash.classList.remove('flash'),140);
            }, t);
          });
        }
        await new Promise(r=>setTimeout(r, 1400));

        // Impact & collapse
        dangerStrobe(); sweepBars(); radioSweep();
        await scrambleNode(span, 160);
        injectGlitch(3); whisper({duration:1.1, cutoff:950, q:9, gain:0.18, pan:0.6, reverse:true});
        clockCtl.setRate(130);

        // Fade text → reveal sigil
        wrap.style.transition='opacity 420ms ease'; wrap.style.opacity='0'; wrap.style.pointerEvents='none';
        setTimeout(()=>{ final.classList.add('show'); randomLogoGlitches(); }, 420);
        setTimeout(()=>{ clockCtl.stop(); }, 560);
      }
    }

    // Under-sigil ambience
    sigilWhisperTimer = setInterval(()=>{
      if(Math.random()<0.66) whisper({duration:0.95, cutoff:900+Math.random()*1100, q:8, gain:0.12, pan:(Math.random()<0.5?-0.7:0.7), reverse:Math.random()<0.55});
      if(Math.random()<0.55) radioSweep();
    }, 1100);
  }

  /* Robust start */
  function arm(){
    if (document.body.dataset.started === "1") return;
    document.body.dataset.started = "1";
    try{
      if(!ac){ bootAudio(); }
      if(ac && ac.state === "suspended"){ ac.resume(); }
    }catch(e){}
    if (gate) gate.classList.add('off');
    run();
  }
  if (gateBtn){
    gateBtn.addEventListener('click', arm, { once:true });
    gateBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); arm(); }, { passive:false, once:true });
  }
  function globalFirstGesture(){
    arm();
    window.removeEventListener('click', globalFirstGesture, true);
    window.removeEventListener('touchend', globalFirstGesture, true);
  }
  window.addEventListener('click', globalFirstGesture, true);
  window.addEventListener('touchend', globalFirstGesture, { passive:true, capture:true });

  // Optional: ?auto=1 to bypass gate for testing
  if (new URLSearchParams(location.search).get('auto') === '1') {
    setTimeout(arm, 50);
  }

  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){
      if(tickTimer) clearTimeout(tickTimer);
      if(crackleTimer) clearTimeout(crackleTimer);
      if(sigilWhisperTimer) clearInterval(sigilWhisperTimer);
      if(obfTimer) clearTimeout(obfTimer);
    }
  });
})();
</script>
</body>
</html>
